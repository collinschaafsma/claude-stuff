#!/usr/bin/env bash
set -e

worktree_path=$(pwd)
git_dir=$(git rev-parse --git-dir 2>/dev/null)

if [[ ! "$git_dir" == *".git/worktrees"* ]]; then
  echo "Error: Not in a git worktree"
  exit 1
fi

branch_name=$(git branch --show-current)
safe_branch_name="${branch_name//\//-}"
repo_name=$(basename "$(git rev-parse --git-common-dir | sed 's/\/.git$//')")
compose_project="${repo_name}-${safe_branch_name}"
main_repo=$(git rev-parse --git-common-dir | sed 's/\/.git$//')

echo "This will:"
echo "  - Stop Docker Sandbox for: $compose_project (if exists)"
echo "  - Stop containers and delete volumes for: $compose_project"
echo "  - Remove worktree at: $worktree_path"
echo "  - Delete local branch: $branch_name"
echo ""
read -p "Are you sure? (y/N) " confirm

if [[ "$confirm" != [yY] ]]; then
  echo "Aborted"
  exit 0
fi

# Remove Docker Sandbox if it exists (search by name)
# Note: docker sandbox ls doesn't support --format, so we parse the table output
# Format: SANDBOX ID | TEMPLATE | NAME | WORKSPACE | STATUS | CREATED
sandbox_id=$(docker sandbox ls --no-trunc 2>/dev/null | awk -v name="$compose_project" '$3 == name {print $1}')
if [[ -n "$sandbox_id" ]]; then
  echo "üê≥ Removing Docker Sandbox: $sandbox_id ($compose_project)"
  docker sandbox rm "$sandbox_id" 2>/dev/null || true
else
  echo "‚ÑπÔ∏è  No Docker Sandbox found with name: $compose_project"
fi

# Stop containers and remove volumes
COMPOSE_PROJECT_NAME="$compose_project" docker compose down -v

cd "$main_repo"
git worktree remove "$worktree_path" --force
git branch -D "$branch_name"

cd ..

echo "‚úÖ Cleaned up worktree, sandbox, containers, volumes, and branch '$branch_name'"
